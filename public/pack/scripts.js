var App=angular.module("App",["ngSanitize","ui.router","ui.sortable","ui.bootstrap","templates"]);angular.module("App").config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider",function(e,t,n,a){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"],n.html5Mode(!0).hashPrefix("!"),t.otherwise("/"),e.state("index",{url:"/",controller:"CV_index as ctr",templateUrl:"templates/views/index.html"}).state("stats",{url:"/stats/?tag&c&t&s&tag2&t2&c2&s2",controller:"CV_stats as ctr",templateUrl:"templates/views/stats.html",reloadOnSearch:!1})}]),angular.module("App").constant("__api",{base:"http://www.sports.ru",baseHack:"http://hack03.sports.ru",paths:{getTournamentsList:"/stat/player/get_seasons/",getTagStat:"/stat/player/get_info/",search:"/search/search.json"}}),angular.module("App").run(["$rootScope",function(e){e.$on("$stateChangeStart",function(t,n){e.state=n.name})}]),angular.module("App").controller("C_root",["$scope","$timeout","S_api",function(e,t){var n=this;return e.$on("goSearch",function(){n.hideView=!0,t(function(){n.lowIndex=!0,n.hidePlayers=!0,t(function(){n.hideView=!1})},250)}),n}]),angular.module("App").directive("autocompleteArea",[function(){return{scope:{info:"=",withButton:"=",info:"="},templateUrl:"templates/directives/autocompleteArea.html",controller:"CD_autocompleteArea as ctr",link:function(e,t){if(e.withButton){var n="notShowing",a=t.find("input"),o=$(document.createElement("div")).html("Сравнить с другим игроком").addClass("onfocusbutton btn btn-primary").on("click",function(){a.trigger("focus"),$(this).addClass(n)}).appendTo(t.find('[data-role="area"]'));a.on("blur",function(){""===$(this).val()&&o.removeClass(n)})}}}}]),angular.module("App").directive("autofocusField",["$timeout",function(e){return{scope:{},link:function(t,n){e(function(){n.find("input").trigger("focus")},0)}}}]),angular.module("App").directive("colorPicker",[function(){return{scope:{color:"=colorPicker",colorChange:"&",tagNum:"="},link:function(e,t,n){return"undefined"==typeof e.color?void t.addClass("pickerIsInited").ColorPickerSliders({placement:n.placement||"right",hsvpanel:!0,sliders:!1,swatches:!1,previewformat:"hex"}):void e.$watch(function(){return e.color},function(a){a&&!t.hasClass("pickerIsInited")&&t.addClass("pickerIsInited").val(a).ColorPickerSliders({placement:n.placement||"right",hsvpanel:!0,sliders:!1,swatches:!1,previewformat:"hex",onchange:function(){if("function"==typeof e.colorChange){var n=t.val().replace("#","");e.colorChange({color:n,key:e.tagNum})}}})})}}}]),angular.module("App").directive("customSelect",function(){return{transclude:!0,scope:{selectId:"=customSelect",closeOnSelect:"=",options:"=",sectionFormat:"=",sectionDefault:"=",optionFormat:"=",optionDisabled:"&",optionActive:"&",onSelect:"&",options:"=",customContent:"="},controller:"CD_customSelect as cSCtr",templateUrl:"templates/directives/customSelect.html",link:function(e,t,n,a,o){var r=e.$parent.$new(),s=e;o(r,function(e,n){n.$close=s.cSCtr.close,t.find('[data-role="custom-content"]').append(e)}),t.find("menu").on("click",function(e){e.stopPropagation()})}}}),angular.module("App").directive("flagIcon",[function(){return{scope:{flag:"=flagIcon"},link:function(e,t){e.$watch("flag",function(e){e&&t.addClass("flag-icon-"+e)})}}}]),angular.module("App").directive("goalsTimeline",[function(){return{scope:{data:"=goalsTimeline",color:"="},link:function(e,t){var n;e.$watch("color",function(t){t&&n&&e.data&&_.forEach(n.highcharts().series,function(e){e.options.color=t,e.update(e.options)})}),e.$watch("data",function(a){if(a){for(var o,r=[],s=_.max(a,function(e){return r.push(e.period),e.goals_count}).goals_count,o=[],i=0;s>i;i++){var l=[];_.forEach(a,function(e){l.push(e.goals_count>i?1:0)}),o.push({data:l,color:e.color})}if(0===s)return void t.addClass("empty");n=t.highcharts({chart:{type:"column"},title:{text:null},xAxis:{categories:r},yAxis:{min:0,lineWidth:0,minorGridLineWidth:0,gridLineWidth:0,lineColor:"transparent",title:{text:null},labels:{enabled:!1},minorTickLength:0,tickLength:0,stackLabels:{enabled:!0,style:{fontSize:"22px",bottom:"10px",color:Highcharts.theme&&Highcharts.theme.textColor||"#000"}}},legend:{enabled:!1},tooltip:{enabled:!1,formatter:function(){return"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y+"<br/>Total: "+this.point.stackTotal}},plotOptions:{column:{stacking:"normal",animation:!1,dataLabels:{enabled:!1}},series:{states:{hover:{enabled:!1}}}},series:o}),n.find('text:contains("Highcharts.com")').remove()}})}}}]),angular.module("App").directive("imageSaveArea",[function(){return{scope:{save:"=imageSaveArea"},link:function(e,t){e.$watch("save",function(e){if(e){{var n=t.get(0),a=2*t.width();t.height()}e===!0&&html2canvas(n,{width:a,useCORS:!0,onrendered:function(e){e.toBlob(function(e){saveAs(e,"stats.png")})}})}})}}}]),angular.module("App").directive("manyPeoples",[function(){return{scope:{animate:"="},templateUrl:"templates/directives/manyPeoples.html",link:function(e,t){for(var n=99,a=48,o=$(window).height(),r=$(window).width(),s=t.find('[data-role="collector"]'),i=Math.ceil(r/a)+2,l=Math.ceil(o/a)+2,c=i*l,u=i*a,d=l*a,g="",m=0;c>m;m++)g+='<div class="player" style="background-image: url(/images/faces/'+(m%n+1)+'.jpeg)"><span></span></div>';e.$watch("animate",function(e){e===!0&&s.find(".player").each(function(){var e=$(this).css("transition",1e3*Math.random()+2200+"ms");e.addClass("go")})}),s.css({width:u+"px",height:d+"px",top:"-24px",left:"-24px"}).html(g)}}}]),angular.module("App").directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),angular.module("App").directive("setBgOnLoad",["$timeout","S_utils",function(e,t){return{scope:{src:"=setBgOnLoad",newLayer:"="},link:function(n,a){var o;n.newLayer||(o=$(document.createElement("div")).addClass("layer").appendTo(a)),n.$watch("src",function(r){if(r){a.removeClass("active");var s=600,i=t.loadImage(n.src),l=(new Date).getTime();i.then(n.newLayer?function(){var t=a.find(".layer"),o=$(document.createElement("div")).addClass("layer").css({"background-image":"url("+n.src+")"}).appendTo(a);e(function(){o.addClass("active")},100),e(function(){t.remove()},s)}:function(){var t=(new Date).getTime();s>t-l?e(function(){o.css({"background-image":"url("+n.src+")"}).addClass("active")},s-(t-l)):o.css({"background-image":"url("+n.src+")"}).addClass("active")})}})}}}]),angular.module("App").service("S_api",["$http","$timeout","$q","__api",function(e,t,n,a){var o={},r=(a.base,a.baseHack);return o.searchByQuery=function(t){return e({url:r+a.paths.search,method:"GET",params:{query:t,only:"players",fav_sport:"208"}})},o.getTournamentsList=function(t){return e({url:r+a.paths.getTournamentsList,method:"GET",params:{tag_id:t}})},o.getTagStat=function(t,n,o){return e({url:r+a.paths.getTagStat,method:"GET",params:{tag_id:t,season_id:o,tournament_id:n}})},o._getTournamentsList=function(){var e=n.defer();return t(function(){e.resolve({tournamet_list:[{name:"Российская премьер-лига",seasons:[{id:354,name:"Сезон 2014/15"},{id:355,name:"Сезон 2013/14"},{id:356,name:"Сезон 2012/13"}],id:12423533},{name:"Какая-то еще лига",seasons:[{id:1355,name:"Сезон 2013/14"},{id:1356,name:"Сезон 2012/13"}],id:12423533}]})},1e3),e.promise},o._getTagStat=function(){var e=n.defer();return t(function(){e.resolve({player_name:"Александр",player_surname:"Кокорин",avatar:"http://s5o.ru/storage/simple/ru/edt/44/18/55/31/rue9281df824f.png",birth_date:"1982-11-03 00:00:00",height:182,weight:72,flag:{flag_url:"http://s5o.ru/common/css/i/flags-sprite.png",flag_country:"Россия",flag_code:"ru"},team:{name:"Динамо",logo:"http://s5o.ru/storage/simple/ru/edt/89/83/60/09/ruea2f670fde9.jpg",tag_url:"http://www.sports.ru/dynamo/"},amplua:"Нападающий",tag_url:"http://www.sports.ru/kokorin/",background_images:[{url:"http://s5o.ru/storage/simple/ru/edt/89/14/51/73/rue514b41dfa7.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/85/79/56/26/rue8607905bce.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/41/64/64/95/rued3d92c842a.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/84/42/72/05/rue31356179ee.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/86/02/54/20/ruef856755f40.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/86/08/53/34/rue2d9fc0aace.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/84/54/29/08/rue09a8cca094.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/20/22/21/27/rue05cdcac0cf.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/20/17/10/99/rue104243346a.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/52/82/45/89/ruefce727ee00.jpg"},{url:"http://s5o.ru/storage/simple/ru/edt/04/84/56/56/rue8839ad570a.49.670x1340.jpeg"},{url:"http://s5o.ru/storage/simple/ru/edt/03/57/60/36/ruef4b81e0a03.49.670x1340.jpeg"},{url:"http://s5o.ru/storage/simple/ru/edt/58/03/47/29/rue809df0a512.jpeg"},{url:"http://s5o.ru/storage/simple/ru/edt/34/75/58/95/rue9dadbe4331.49.670x1340.jpeg"}],stat:{season:"Сезон 2014/2015 ",tournament:"премьер-лига Россия",goals:6,goal_passes:5,minutes:984,efficient_minutes:90,goals_timeline:[{period:"0-15",goals_count:2},{period:"15-30",goals_count:1},{period:"30-45",goals_count:0},{period:"45-60",goals_count:0},{period:"60-75",goals_count:3},{period:"75-90",goals_count:2}],yellow_cards:1,red_cards:4,most_efficient_match:[{teams:"Спартак-Динамо",score:"0:2",goals:4,date:"2014-02-24"},{teams:"Спартак-Динамо",score:"0:6",goals:7,date:"2014-09-22"}],matches_count:12}})},1e3),e.promise},o}]),angular.module("App").service("S_eventer",["$rootScope",function(e){var t={};return t.sendEvent=function(t,n){e.$broadcast(t,n)},t}]),angular.module("App").service("S_location",["$location",function(e){var t;return t={setAttr:function(t,n){var a={};a[t]=n,e.search(angular.extend(e.$$search,a))}}}]),angular.module("App").service("S_utils",["$q",function(e){function t(e){var t="string"==typeof e?n(e):e;return.2126*t[0]+.7152*t[1]+.0722*t[2]}function n(e){if(3===e.length)e=e.charAt(0)+e.charAt(0)+e.charAt(1)+e.charAt(1)+e.charAt(2)+e.charAt(2);else if(6!==e.length)throw"Invalid hex color: "+e;for(var t=[],n=0;2>=n;n++)t[n]=parseInt(e.substr(2*n,2),16);return t}var a={};return a.loadImage=function(t){var n=e.defer(),a=new Image;return a.src=t,a.onload=function(){n.resolve(this)},a.onerror=function(){n.reject(this)},n.promise},a.plural=function(e,t,n,a){return e=Math.abs(e),e%=100,e>=5&&20>=e?a:(e%=10,1==e?t:e>=2&&4>=e?n:a)},a.getVersusBackgrounds=function(){return[{url:"/images/versus-bg/fvs01.png"},{url:"/images/versus-bg/fvs02.png"},{url:"/images/versus-bg/fvs03.png"},{url:"/images/versus-bg/fvs04.png"},{url:"/images/versus-bg/fvs05.png"},{url:"/images/versus-bg/fvs06.png"},{url:"/images/versus-bg/fvs07.png"}]},a.getContrastColor=function(e){return t(e)>=165?"000":"fff"},a}]),angular.module("App").controller("CD_autocompleteArea",["$scope","S_api",function(e,t){var n=this;return n.searchByQuery=function(e){return t.searchByQuery(e).then(function(e){return e.data.suggestions})},n.onTagSelect=function(t){e.info=t},n}]),angular.module("App").controller("CD_customSelect",["$timeout","$scope","$interpolate","$sce",function(e,t,n,a){var o=this;return t.length=123,t.$watch("sectionFormat",function(){t.section=a.trustAsHtml(n("<span>"+t.sectionFormat+"</span>")(t))}),o.close=function(){o.opened=!1,$("body").off("click")},o.open=function(){o.opened=!o.opened,o.opened?e(function(){$("body").on("click",function(){t.$apply(function(){o.opened=!1}),$(this).off("click")})}):$("body").off("click")},o.isDisabled=function(e){return t.optionDisabled()?t.optionDisabled()(e,t.selectId):void 0},o.isActive=function(e){return t.optionActive()?t.optionActive()(e,t.selectId):void 0},o.selectOption=function(e,n){e.stopPropagation(),t.selected=n,t.closeOnSelect&&o.open()},o}]),angular.module("App").controller("CV_index",["$state","$q","$scope","S_api","S_utils","S_eventer",function(e,t,n,a,o,r){var s=this;return s.leftSideInfo={selectedTournament:{},selectedSeason:{},info:{},color:"#A6FF00"},s.rightSideInfo={selectedTournament:{},selectedSeason:{},info:{},color:"#FFA600"},n.$watch(function(){return s.leftSideInfo.info},function(e){e&&e.name&&(s.leftSideInfo.info=e,s.leftSideInfo.preloadingTagInfo=!0,r.sendEvent("goSearch"),t.all({image:o.loadImage(e.img),tournaments:a.getTournamentsList(e.id)}).then(function(e){s.leftSideInfo.preloadingTagInfo=!1,s.leftSideInfo.tournaments=e.tournaments.data.tournament_list}))}),n.$watch(function(){return s.rightSideInfo.info},function(e){e&&e.name&&(s.rightSideInfo.info=e,s.rightSideInfo.preloadingTagInfo=!0,t.all({image:o.loadImage(e.img),tournaments:a.getTournamentsList(e.id)}).then(function(e){s.rightSideInfo.preloadingTagInfo=!1,s.rightSideInfo.tournaments=e.tournaments.data.tournament_list}))}),s.getCollectorByKey=function(e){return e?s.rightSideInfo:s.leftSideInfo},s.secondTagIsReady=function(){return s.showTagInfo[1]},s.selectParam=function(e,t,n){switch(n){case"tour":s.getCollectorByKey(e).selectedTournament.name!==t.name&&(s.getCollectorByKey(e).selectedSeason={}),s.getCollectorByKey(e).selectedTournament=t,s.getCollectorByKey(e).seasons=t.seasons;break;case"season":s.getCollectorByKey(e).selectedSeason=t}},s.setColor=function(e,t){s.getCollectorByKey(t).color=e.currentTarget.value},s.paramIsActive=function(e,t,n){switch(n){case"tour":return s.getCollectorByKey(e).selectedTournament.name===t.name;case"season":return s.getCollectorByKey(e).selectedSeason.name===t.name}},s.tournamentsIsLoaded=function(e){return s.getCollectorByKey(e).tournaments},s.tournamentIsSelected=function(e){return s.getCollectorByKey(e).selectedTournament.name},s.seasonIsSelected=function(e){return s.getCollectorByKey(e).selectedSeason.name},s.showTagPreloader=function(e){return s.getCollectorByKey(e).preloadingTagInfo===!0},s.statsButtonIsActive=function(){return s.rightSideInfo.info.name?s.seasonIsSelected(0)&&s.seasonIsSelected(1):s.seasonIsSelected(0)},s.getSelectPlaceholder=function(e,t){switch(t){case"tour":return s.getCollectorByKey(e).selectedTournament.name?s.getCollectorByKey(e).selectedTournament.name:"Выберите турнир";case"season":return s.getCollectorByKey(e).selectedSeason.name?s.getCollectorByKey(e).selectedSeason.name:"Выберите сезон"}return s.selectedParams[e].description?s.selectedParams[e].description:"Выберите параметр"},s.loadStats=function(){s.statsButtonIsActive()&&(s.seasonIsSelected(1)?e.go("^.stats",{tag:s.leftSideInfo.info.id,c:s.leftSideInfo.color.replace("#",""),t:s.leftSideInfo.selectedTournament.id,s:s.leftSideInfo.selectedSeason.id,tag2:s.rightSideInfo.info.id,c2:s.rightSideInfo.color.replace("#",""),t2:s.rightSideInfo.selectedTournament.id,s2:s.rightSideInfo.selectedSeason.id}):e.go("^.stats",{tag:s.leftSideInfo.info.id,c:s.leftSideInfo.color.replace("#",""),t:s.leftSideInfo.selectedTournament.id,s:s.leftSideInfo.selectedSeason.id}))},s}]),angular.module("App").controller("CV_stats",["$state","$timeout","$q","$scope","S_api","S_utils","S_location",function(e,t,n,a,o,r,s){var i=this,l=e.params.c,c=e.params.c2;return i.preloadingInfo=!0,i.solo={},i.versus={},e.params.tag2?(i.oneTag=!1,n.all({tag1:o.getTagStat(e.params.tag,e.params.t,e.params.s),tag2:o.getTagStat(e.params.tag2,e.params.t2,e.params.s2)}).then(function(e){i.preloadingInfo=!1;var a=i.versus;a.tag1=e.tag1.data,a.tag2=e.tag2.data,a.mainImageIndex=0,a.background_image=r.getVersusBackgrounds(),a.mainImage=a.background_image[0].url,a.tag1.age=moment().diff(moment(a.tag1.birth_date,"YYYY-MM-DD HH:mm:ss"),"years"),a.tag2.age=moment().diff(moment(a.tag2.birth_date,"YYYY-MM-DD HH:mm:ss"),"years"),a.tag1.age+=" "+r.plural(a.tag1.age,"год","года","лет"),a.tag2.age+=" "+r.plural(a.tag2.age,"год","года","лет"),n.all({avatar1:r.loadImage(a.tag1.avatar),avatar2:r.loadImage(a.tag2.avatar),mainImage:r.loadImage(a.mainImage)}).then(function(){t(function(){i.readyToShow=!0},500)})})):(i.oneTag=!0,n.all({tag:o.getTagStat(e.params.tag,e.params.t,e.params.s)}).then(function(e){i.preloadingInfo=!1,i.solo=e.tag.data,i.solo.mainImageIndex=0,i.solo.mainImage=i.solo.background_image[0].url;var a=moment(i.solo.birth_date,"YYYY-MM-DD HH:mm:ss");i.solo.age=moment().diff(a,"years"),i.solo.age+=" "+r.plural(i.solo.age,"год","года","лет"),i.solo.birthdayHuman=a.format("D MMMM YYYY"),n.all({avatar:r.loadImage(i.solo.avatar),mainImage:r.loadImage(i.solo.mainImage)}).then(function(){t(function(){i.readyToShow=!0},500)})})),i.getTagInfo=function(e){return"number"==typeof e?e?i.versus.tag2:i.versus.tag1:e},i.getColor=function(e){return"#"+(e?c:l)},i.getTextColor=function(e){return"#"+r.getContrastColor(e?c:l)},i.setColor=function(e,t){a.$apply(function(){t?(c=e,s.setAttr("c2",e)):(l=e,s.setAttr("c",e))})},i.nextTagImage=function(e){var t=i.getTagInfo(e),n=t.mainImageIndex,a=t.background_image.length;a-1>n+1?t.mainImageIndex++:t.mainImageIndex=0,t.mainImage=t.background_image[t.mainImageIndex].url},i.toggleImage=function(e){var t=i.getTagInfo(e);t.witoutTopImage=!t.witoutTopImage},i.witoutBackground=function(e){return i.getTagInfo(e).witoutTopImage},i.sortableOptions={axis:"y",handle:".reorder"},i.bannedSections=[],i.sectionIsBanned=function(e){var t=_.find(i.bannedSections,function(t){return t===e});return t},i.toggleSection=function(e){var t=_.remove(i.bannedSections,function(t){return t===e});t&&t.length||i.bannedSections.push(e)},i.toHumanMatchDate=function(e){return moment(e,"YYYY-MM-DD").format("DD.MM.YYYY")},i.saveImage=function(){i.savingInProgress=!0},i.thisIsEmptyTimeline=function(e){return 0===_.max(e,function(e){return e.goals_count}).goals_count},i}]);